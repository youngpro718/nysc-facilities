# 🏗️ NYSC Facilities Hub - Technical Architecture

## System Architecture Overview

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         NYSC FACILITIES HUB                              │
│                    Court Facility Management System                      │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                           PRESENTATION LAYER                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌─────────────┐│
│  │   React UI   │  │  Shadcn/ui   │  │ Tailwind CSS │  │ Lucide Icons││
│  │   18.2.0     │  │  Components  │  │   3.4.17     │  │   0.462.0   ││
│  └──────────────┘  └──────────────┘  └──────────────┘  └─────────────┘│
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                     React Router 6.30.1                           │  │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐           │  │
│  │  │  Admin   │ │   User   │ │  Public  │ │Protected │           │  │
│  │  │  Routes  │ │  Routes  │ │  Routes  │ │  Routes  │           │  │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘           │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          STATE MANAGEMENT LAYER                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │               React Query (TanStack Query 5.84.1)              │    │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐         │    │
│  │  │  Server  │ │  Cache   │ │ Mutations│ │Real-time │         │    │
│  │  │  State   │ │ Manager  │ │ Manager  │ │  Sync    │         │    │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘         │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                 │
│  │   Zustand    │  │   Context    │  │  Local State │                 │
│  │ Client State │  │  Auth/Theme  │  │  (useState)  │                 │
│  └──────────────┘  └──────────────┘  └──────────────┘                 │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          BUSINESS LOGIC LAYER                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                       Custom Hooks                              │    │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐         │    │
│  │  │useSpaces │ │useIssues │ │  useKeys │ │useOccup. │         │    │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘         │    │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐         │    │
│  │  │useCourt  │ │useInvent.│ │useSupply │ │useAnalyt.│         │    │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘         │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                       Service Layer                             │    │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐         │    │
│  │  │  Spaces  │ │  Issues  │ │   Keys   │ │Personnel │         │    │
│  │  │ Service  │ │ Service  │ │ Service  │ │ Service  │         │    │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘         │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        DATA ACCESS LAYER                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │              Supabase Client (@supabase/supabase-js)           │    │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐         │    │
│  │  │  Query   │ │  Insert  │ │  Update  │ │  Delete  │         │    │
│  │  │ Builder  │ │ Builder  │ │ Builder  │ │ Builder  │         │    │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘         │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                 │
│  │   Real-time  │  │     Auth     │  │   Storage    │                 │
│  │Subscriptions │  │   Manager    │  │   Manager    │                 │
│  └──────────────┘  └──────────────┘  └──────────────┘                 │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           BACKEND LAYER                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                    Supabase PostgreSQL                          │    │
│  │                                                                 │    │
│  │  ┌─────────────────────────────────────────────────────────┐  │    │
│  │  │                   Core Tables (50+)                      │  │    │
│  │  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │  │    │
│  │  │  │buildings │ │  floors  │ │  rooms   │ │  issues  │   │  │    │
│  │  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │  │    │
│  │  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │  │    │
│  │  │  │ profiles │ │personnel │ │occupants │ │  keys    │   │  │    │
│  │  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │  │    │
│  │  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │  │    │
│  │  │  │inventory │ │ supplies │ │  court   │ │mainten.  │   │  │    │
│  │  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │  │    │
│  │  └─────────────────────────────────────────────────────────┘  │    │
│  │                                                                 │    │
│  │  ┌─────────────────────────────────────────────────────────┐  │    │
│  │  │                   Database Views                         │  │    │
│  │  │  • unified_spaces      • key_inventory_view             │  │    │
│  │  │  • personnel_profiles  • unified_personnel_view         │  │    │
│  │  │  • spaces_dashboard_mv (materialized)                   │  │    │
│  │  └─────────────────────────────────────────────────────────┘  │    │
│  │                                                                 │    │
│  │  ┌─────────────────────────────────────────────────────────┐  │    │
│  │  │                   RPC Functions                          │  │    │
│  │  │  • get_dashboard_stats()    • create_key_order()        │  │    │
│  │  │  • get_building_hierarchy() • get_facility_analytics()  │  │    │
│  │  │  • process_key_order_receipt() • auto_create_key_order()│  │    │
│  │  └─────────────────────────────────────────────────────────┘  │    │
│  │                                                                 │    │
│  │  ┌─────────────────────────────────────────────────────────┐  │    │
│  │  │              Row Level Security (RLS)                    │  │    │
│  │  │  • User-based policies  • Role-based policies           │  │    │
│  │  │  • Admin overrides      • Module permissions            │  │    │
│  │  └─────────────────────────────────────────────────────────┘  │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                 │
│  │   Supabase   │  │   Supabase   │  │   Supabase   │                 │
│  │     Auth     │  │   Storage    │  │  Real-time   │                 │
│  └──────────────┘  └──────────────┘  └──────────────┘                 │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        DEPLOYMENT LAYER                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                         Netlify CDN                             │    │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐         │    │
│  │  │  Static  │ │   Edge   │ │  Build   │ │   SSL    │         │    │
│  │  │  Assets  │ │Functions │ │ Pipeline │ │   Cert   │         │    │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘         │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  Production URL: https://nysc-facilities.windsurf.build                 │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Data Flow Architecture

### Request Flow (Read Operation)

```
┌──────────┐
│  User    │
│Interface │
└────┬─────┘
     │ 1. User Action (e.g., view rooms)
     ▼
┌────────────────┐
│ React Component│
└────┬───────────┘
     │ 2. Call custom hook
     ▼
┌────────────────┐
│  Custom Hook   │ (e.g., useRooms)
│ (React Query)  │
└────┬───────────┘
     │ 3. Check cache
     ├─── Cache Hit ──────┐
     │                    │
     │ 4. Cache Miss      │
     ▼                    │
┌────────────────┐        │
│ Service Layer  │        │
└────┬───────────┘        │
     │ 5. Business logic  │
     ▼                    │
┌────────────────┐        │
│  Data Access   │        │
│     Layer      │        │
└────┬───────────┘        │
     │ 6. Supabase query  │
     ▼                    │
┌────────────────┐        │
│   Supabase     │        │
│   PostgreSQL   │        │
└────┬───────────┘        │
     │ 7. Return data     │
     ▼                    │
┌────────────────┐        │
│  React Query   │◄───────┘
│     Cache      │
└────┬───────────┘
     │ 8. Update UI
     ▼
┌────────────────┐
│ React Component│
│   (Re-render)  │
└────────────────┘
```

### Mutation Flow (Write Operation)

```
┌──────────┐
│  User    │
│ Action   │
└────┬─────┘
     │ 1. Submit form
     ▼
┌────────────────┐
│ React Component│
└────┬───────────┘
     │ 2. Call mutation
     ▼
┌────────────────┐
│  React Query   │
│   Mutation     │
└────┬───────────┘
     │ 3. Optimistic update (optional)
     ├─── Update UI immediately
     │
     │ 4. Execute mutation
     ▼
┌────────────────┐
│ Service Layer  │
└────┬───────────┘
     │ 5. Validation & business logic
     ▼
┌────────────────┐
│  Data Access   │
└────┬───────────┘
     │ 6. Supabase mutation
     ▼
┌────────────────┐
│   Supabase     │
│   PostgreSQL   │
└────┬───────────┘
     │ 7. Success/Error response
     ▼
┌────────────────┐
│  React Query   │
│   Mutation     │
└────┬───────────┘
     │ 8. Invalidate cache
     │ 9. Refetch affected queries
     ▼
┌────────────────┐
│ React Component│
│   (Re-render)  │
└────┬───────────┘
     │ 10. Show toast notification
     ▼
┌────────────────┐
│     User       │
│   Feedback     │
└────────────────┘
```

---

## Security Architecture

### Authentication Flow

```
┌──────────┐
│  User    │
│  Login   │
└────┬─────┘
     │ 1. Enter credentials
     ▼
┌────────────────┐
│ Login Component│
└────┬───────────┘
     │ 2. Submit to Supabase Auth
     ▼
┌────────────────┐
│  Supabase Auth │
└────┬───────────┘
     │ 3. Validate credentials
     ├─── Invalid ───► Error message
     │
     │ 4. Valid credentials
     ▼
┌────────────────┐
│  JWT Token     │
│   Generated    │
└────┬───────────┘
     │ 5. Store in localStorage
     ▼
┌────────────────┐
│  Auth Context  │
└────┬───────────┘
     │ 6. Fetch user profile
     ▼
┌────────────────┐
│  user_roles    │
│     Table      │
└────┬───────────┘
     │ 7. Get role & permissions
     ▼
┌────────────────┐
│  Auth State    │
│   Updated      │
└────┬───────────┘
     │ 8. Redirect based on role
     ├─── Admin ───► /
     └─── User  ───► /dashboard
```

### Authorization Flow

```
┌──────────┐
│  User    │
│ Request  │
└────┬─────┘
     │ 1. Navigate to protected route
     ▼
┌────────────────┐
│ProtectedRoute  │
│   Component    │
└────┬───────────┘
     │ 2. Check authentication
     ├─── Not authenticated ───► Redirect to /login
     │
     │ 3. Authenticated
     ▼
┌────────────────┐
│  Check Role    │
└────┬───────────┘
     │ 4. Verify role permissions
     ├─── No permission ───► Redirect to /dashboard
     │
     │ 5. Has permission
     ▼
┌────────────────┐
│Module Protected│
│     Route      │
└────┬───────────┘
     │ 6. Check module enabled
     ├─── Module disabled ───► Show error message
     │
     │ 7. Module enabled
     ▼
┌────────────────┐
│  Render Page   │
└────┬───────────┘
     │ 8. Apply RLS policies
     ▼
┌────────────────┐
│  Data Access   │
│  (Filtered)    │
└────────────────┘
```

---

## Module Architecture

### Spaces Module

```
┌─────────────────────────────────────────┐
│           Spaces Management             │
├─────────────────────────────────────────┤
│                                         │
│  ┌───────────────────────────────────┐ │
│  │         SpacesPage.tsx            │ │
│  └───────────────┬───────────────────┘ │
│                  │                     │
│      ┌───────────┼───────────┐        │
│      ▼           ▼           ▼        │
│  ┌────────┐ ┌────────┐ ┌────────┐    │
│  │ Rooms  │ │Infrastr│ │ Floor  │    │
│  │  Tab   │ │ucture  │ │  Plan  │    │
│  └────┬───┘ └────┬───┘ └────┬───┘    │
│       │          │          │         │
│       ▼          ▼          ▼         │
│  ┌────────────────────────────────┐  │
│  │      useSpaces Hook            │  │
│  │  • useRooms()                  │  │
│  │  • useBuildings()              │  │
│  │  • useFloors()                 │  │
│  └────────────┬───────────────────┘  │
│               │                      │
│               ▼                      │
│  ┌────────────────────────────────┐  │
│  │      SpacesService             │  │
│  │  • createSpace()               │  │
│  │  • updateSpace()               │  │
│  │  • deleteSpace()               │  │
│  └────────────┬───────────────────┘  │
│               │                      │
│               ▼                      │
│  ┌────────────────────────────────┐  │
│  │      Database Tables           │  │
│  │  • buildings                   │  │
│  │  • floors                      │  │
│  │  • rooms                       │  │
│  │  • unified_spaces (view)       │  │
│  └────────────────────────────────┘  │
│                                       │
└───────────────────────────────────────┘
```

### Court Operations Module

```
┌─────────────────────────────────────────┐
│        Court Operations                 │
├─────────────────────────────────────────┤
│                                         │
│  ┌───────────────────────────────────┐ │
│  │  CourtOperationsDashboard.tsx     │ │
│  └───────────────┬───────────────────┘ │
│                  │                     │
│      ┌───────────┼───────────┬────────┤
│      ▼           ▼           ▼        ▼
│  ┌────────┐ ┌────────┐ ┌────────┐ ┌────┐
│  │Courtroom│ │Shutdowns│ │Assignm.│ │Terms│
│  │ Status │ │        │ │        │ │    │
│  └────┬───┘ └────┬───┘ └────┬───┘ └─┬──┘
│       │          │          │        │
│       ▼          ▼          ▼        ▼
│  ┌────────────────────────────────────┐
│  │    useCourtOperations Hooks        │
│  │  • useCourtRooms()                 │
│  │  • useCourtAssignments()           │
│  │  • useCourtTerms()                 │
│  │  • useCourtPersonnel()             │
│  └────────────┬───────────────────────┘
│               │                        │
│               ▼                        │
│  ┌────────────────────────────────────┐
│  │      Database Tables               │
│  │  • court_rooms (32)                │
│  │  • court_assignments               │
│  │  • court_terms                     │
│  │  • room_shutdowns                  │
│  │  • personnel_profiles (150+)       │
│  └────────────────────────────────────┘
│                                         │
└─────────────────────────────────────────┘
```

---

## Performance Optimization Strategy

### Caching Strategy

```
┌─────────────────────────────────────────┐
│         React Query Cache               │
├─────────────────────────────────────────┤
│                                         │
│  Stale Time: 4 minutes                  │
│  Cache Time: 5 minutes                  │
│  Refetch on Window Focus: false         │
│                                         │
│  ┌───────────────────────────────────┐ │
│  │     Query Key Structure           │ │
│  │  • ['buildings']                  │ │
│  │  • ['rooms', buildingId]          │ │
│  │  • ['issues', filters]            │ │
│  │  • ['keys']                       │ │
│  │  • ['occupants']                  │ │
│  └───────────────────────────────────┘ │
│                                         │
│  ┌───────────────────────────────────┐ │
│  │   Invalidation Strategy           │ │
│  │  • On mutation success            │ │
│  │  • Manual invalidation            │ │
│  │  • Time-based expiration          │ │
│  └───────────────────────────────────┘ │
│                                         │
└─────────────────────────────────────────┘
```

### Database Optimization

```
┌─────────────────────────────────────────┐
│      Database Optimizations             │
├─────────────────────────────────────────┤
│                                         │
│  ┌───────────────────────────────────┐ │
│  │    Materialized Views             │ │
│  │  • spaces_dashboard_mv            │ │
│  │    (20x faster queries)           │ │
│  └───────────────────────────────────┘ │
│                                         │
│  ┌───────────────────────────────────┐ │
│  │         Indexes                   │ │
│  │  • building_id                    │ │
│  │  • floor_id                       │ │
│  │  • room_id                        │ │
│  │  • user_id                        │ │
│  │  • created_at                     │ │
│  └───────────────────────────────────┘ │
│                                         │
│  ┌───────────────────────────────────┐ │
│  │      Query Optimization           │ │
│  │  • Selective column fetching      │ │
│  │  • Proper JOIN usage              │ │
│  │  • Limit/offset pagination        │ │
│  └───────────────────────────────────┘ │
│                                         │
└─────────────────────────────────────────┘
```

---

## Real-time Architecture

```
┌──────────────────────────────────────────────────────┐
│              Real-time Data Flow                     │
├──────────────────────────────────────────────────────┤
│                                                      │
│  ┌────────────────────────────────────────────────┐ │
│  │         Supabase Real-time                     │ │
│  │  ┌──────────────────────────────────────────┐ │ │
│  │  │     PostgreSQL Change Data Capture       │ │ │
│  │  │  (Triggers on INSERT/UPDATE/DELETE)      │ │ │
│  │  └──────────────┬───────────────────────────┘ │ │
│  │                 │                              │ │
│  │                 ▼                              │ │
│  │  ┌──────────────────────────────────────────┐ │ │
│  │  │        WebSocket Connection              │ │ │
│  │  └──────────────┬───────────────────────────┘ │ │
│  └─────────────────┼──────────────────────────────┘ │
│                    │                                │
│                    ▼                                │
│  ┌────────────────────────────────────────────────┐ │
│  │         RealtimeProvider                       │ │
│  │  • Manages subscriptions                       │ │
│  │  • Handles reconnection                        │ │
│  │  • Broadcasts updates                          │ │
│  └────────────────┬───────────────────────────────┘ │
│                   │                                 │
│       ┌───────────┼───────────┬───────────┐        │
│       ▼           ▼           ▼           ▼        │
│  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐     │
│  │ Issues │ │ Court  │ │  Keys  │ │Notific.│     │
│  │Updates │ │Assignm.│ │Requests│ │        │     │
│  └────┬───┘ └────┬───┘ └────┬───┘ └────┬───┘     │
│       │          │          │          │          │
│       └──────────┴──────────┴──────────┘          │
│                   │                                │
│                   ▼                                │
│  ┌────────────────────────────────────────────────┐ │
│  │         React Query Cache Invalidation         │ │
│  │  • Automatic refetch                           │ │
│  │  • UI updates                                  │ │
│  │  • Toast notifications                         │ │
│  └────────────────────────────────────────────────┘ │
│                                                      │
└──────────────────────────────────────────────────────┘
```

---

**Last Updated:** October 25, 2025  
**Version:** 1.0.0
